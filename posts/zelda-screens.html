<!DOCTYPE HTML>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1" />
	<link rel="stylesheet" href="../css/style.css?Sun Aug 25 13:17:26 2019" />
	<link rel="alternate" type="application/rss+xml" title="pennie-quinn.github.io posts" href="../posts.xml" />
	<title>Making the Same Stuff With Different Tools</title>
	
	<script type="text/javascript">
		window.site_root = "..";
	</script>
	
	<script type="text/javascript">
  if (window.location.hostname != "localhost") {
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-127983421-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  }
</script>
</head>

<body class="nice_fonts">
	
<div class="sidebar">
	<a href="../index.html" title="pennie.net">
		<img class="logo" src="../img/devnull.svg" alt="pennie.net" />
	</a>

	<p class="center">Pennie's ramblings.</p>

	<div class="sidebar_icons">
		<a href="mailto:pennie.ada.quinn@gmail.com"><img src="../img/icon/mail.svg" alt="email" /></a>
		<a href="https://twitter.com/transmutrix"><img src="../img/icon/twitter.svg" alt="twitter" /></a>
		<a href="https://github.com/pennie-quinn"><img src="../img/icon/github.svg" alt="github" /></a>
		<a href="https://pennie.itch.io"><img src="../img/icon/itchio.svg" alt="itch" /></a>
	</div>

	<br>

	<p>Recent Posts</p>
	<p><a href='https://pennie-quinn.github.io/posts/zelda-screens.html'>Making the Same Stuff With Different Tools</a></p>
<p><a href='https://pennie-quinn.github.io/posts/hillcipher.html'>The Lester Hill Cipher</a></p>
<p><a href='https://pennie-quinn.github.io/posts/going-full-bananacakes.html'>Going Full Bananacakes</a></p>

</div>

<div class="main-column">

<div class="post-header">
	<img class="cover" src="../img/default.png" alt="Making the Same Stuff With Different Tools" />
	<h1>Making the Same Stuff With Different Tools</h1>
	<div class="post-meta">
		Posted
		<span class: "post-date">Sun, Aug 25, 2019</span>
		by Pennie (<a href="https://twitter.com/transmutrix">@transmutrix</a>)
	</div>
</div>

<div class="inner post-body"><h2>A Zelda-like in C</h2>

<p>In 2015, I began writing a Zelda-like called Wizwag. I
mentioned this project before in
<a href="../posts/intimacy-of-bugs.html">this post</a> about
corner-walking in 2D Zeldas and Zelda-likes. I also wrote
about the Haxe version&rsquo;s lighting system in
<a href="../posts/haxeflixel-lighting.html">this post.</a></p>

<p>I used C99 and Lua 5.2, wrote my own soft renderer, wrote my
first audio playback system, and my first multi-phase
physics engine. For those reasons, it was a valuable
learning experience. I also wanted to accurately capture the
&ldquo;feel&rdquo; of Gameboy Color era Zelda titles in the artwork and
gameplay.</p>

<p>I opted to use the supertile concept from those games, and
implemented a map editor in the game itself, since most
convenient tilemap editors don&rsquo;t support supertiles and
faking it is tedious. The problem was that I didn&rsquo;t <em>also</em>
write a tool to create the supertiles, so I manually made my
tilesets (yeesh).</p>

<p>Anyway, things got reasonably far along on the toolchain
front, less so the content front, aside from art and
tilesets:</p>

<p><img src="../img/zeldascreens/transition-quantize.gif" alt="gif of in-game dialogue" /></p>

<p>Entity scripting was made as painless as possible, with as
much live-reloading as I could figure out at the time.</p>

<p>Here&rsquo;s what an entity &ldquo;&rdquo;&ldquo;prefab&rdquo;&ldquo;&rdquo; looked like in the game:</p>

<pre class="highlight lang_lua"><code><span></span><span class="c1">-- the file defining collectible money items --</span>

<span class="kd">local</span> <span class="n">sprites</span> <span class="o">=</span> <span class="p">{</span>
    <span class="n">rect</span><span class="p">.</span><span class="n">mindim</span><span class="p">(</span><span class="n">tile8</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">8</span><span class="p">),</span> <span class="n">V2</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span><span class="mi">8</span><span class="p">)),</span>
    <span class="n">rect</span><span class="p">.</span><span class="n">mindim</span><span class="p">(</span><span class="n">tile8</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">9</span><span class="p">),</span> <span class="n">V2</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span><span class="mi">8</span><span class="p">)),</span>
    <span class="n">rect</span><span class="p">.</span><span class="n">mindim</span><span class="p">(</span><span class="n">tile8</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">9</span><span class="p">),</span> <span class="n">V2</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span><span class="mi">8</span><span class="p">)),</span>
    <span class="n">rect</span><span class="p">.</span><span class="n">mindim</span><span class="p">(</span><span class="n">tile8</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">8</span><span class="p">),</span> <span class="n">V2</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span><span class="mi">16</span><span class="p">)),</span>
<span class="p">}</span>

<span class="kd">local</span> <span class="n">spritei</span> <span class="o">=</span> <span class="nb">math.random</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="o">#</span><span class="n">sprites</span><span class="p">)</span>

<span class="kr">return</span> <span class="p">{</span>
    <span class="nb">type</span>        <span class="o">=</span> <span class="n">ETYPE_ITEM</span><span class="p">,</span>
    <span class="n">facing</span>      <span class="o">=</span> <span class="n">FACING_DOWN</span><span class="p">,</span>
    <span class="n">vram</span>        <span class="o">=</span> <span class="n">WIZ_VRAM_ITEM</span><span class="p">,</span>
    <span class="n">sprite</span>      <span class="o">=</span> <span class="n">sprites</span><span class="p">[</span><span class="n">spritei</span><span class="p">],</span>
    <span class="n">bb</span>          <span class="o">=</span> <span class="n">rect</span><span class="p">.</span><span class="n">mindim</span><span class="p">(</span><span class="n">v2</span><span class="p">(</span><span class="o">-</span><span class="mi">4</span><span class="p">,</span><span class="o">-</span><span class="mi">8</span><span class="p">),</span> <span class="n">v2</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span><span class="mi">8</span><span class="p">)),</span>
    <span class="n">material</span>    <span class="o">=</span> <span class="n">EMAT_BOUNCY</span><span class="p">,</span>

    <span class="n">triggers</span> <span class="o">=</span> <span class="p">{</span>
        <span class="n">awake</span> <span class="o">=</span> <span class="kr">function</span><span class="p">(</span><span class="n">self</span><span class="p">)</span>
            <span class="n">self</span><span class="p">:</span><span class="n">jump</span><span class="p">(</span><span class="nb">math.random</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span><span class="mi">32</span><span class="p">))</span>
            <span class="n">self</span><span class="p">:</span><span class="n">loadsound</span><span class="p">(</span><span class="s1">&#39;cash.ogg&#39;</span><span class="p">)</span>
            <span class="n">self</span><span class="p">.</span><span class="n">triggered</span> <span class="o">=</span> <span class="kc">false</span>

            <span class="n">self</span><span class="p">.</span><span class="n">value</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="kr">if</span> <span class="n">spritei</span> <span class="o">==</span> <span class="o">#</span><span class="n">sprites</span> <span class="kr">then</span>
                <span class="n">self</span><span class="p">.</span><span class="n">value</span> <span class="o">=</span> <span class="mi">5</span>
            <span class="kr">end</span>
        <span class="kr">end</span><span class="p">,</span>

        <span class="n">collide</span> <span class="o">=</span> <span class="kr">function</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">other</span><span class="p">)</span>
            <span class="kr">if</span> <span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">triggered</span><span class="p">)</span> <span class="kr">then</span> <span class="kr">return</span> <span class="kr">end</span>
            <span class="kr">if</span> <span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">alive</span> <span class="ow">and</span> <span class="n">other</span><span class="p">.</span><span class="n">player</span><span class="p">)</span> <span class="kr">then</span>
                <span class="n">self</span><span class="p">.</span><span class="n">triggered</span> <span class="o">=</span> <span class="kc">true</span>

                <span class="n">Player</span><span class="p">.</span><span class="n">ChangeGold</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">value</span><span class="p">)</span>
                <span class="n">self</span><span class="p">:</span><span class="n">sprite</span><span class="p">(</span><span class="n">rect</span><span class="p">.</span><span class="n">mindim</span><span class="p">(</span><span class="n">V2</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span><span class="n">V2</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)))</span>
                <span class="n">self</span><span class="p">:</span><span class="n">sfx</span><span class="p">(</span><span class="s1">&#39;cash.ogg&#39;</span><span class="p">,</span> <span class="mf">0.8</span><span class="p">,</span> <span class="nb">math.random</span><span class="p">(</span><span class="mi">75</span><span class="p">,</span><span class="mi">125</span><span class="p">)</span><span class="o">/</span><span class="mi">100</span><span class="p">)</span>

                <span class="n">self</span><span class="p">:</span><span class="n">killafter</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
            <span class="kr">end</span>
        <span class="kr">end</span><span class="p">,</span>
    <span class="p">}</span>
<span class="p">}</span></code>
</pre>


<p>And here&rsquo;s a snippet from the physics engine, which applied
material properties like ice, pits, and conveyors:</p>

<pre class="highlight lang_cpp"><code><span></span><span class="kt">void</span> <span class="nf">wizphys_apply_tile_materials</span><span class="p">(</span><span class="n">wiz_map</span> <span class="o">*</span><span class="n">Map</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">rectangle</span> <span class="n">MapBounds</span> <span class="o">=</span> <span class="n">rect_mindim</span><span class="p">(</span><span class="n">V2</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span> <span class="n">V2</span><span class="p">(</span><span class="n">Map</span><span class="o">-&gt;</span><span class="n">w</span><span class="p">,</span> <span class="n">Map</span><span class="o">-&gt;</span><span class="n">h</span><span class="p">));</span>
    <span class="n">u8</span> <span class="n">Tile</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">wiz_tile</span> <span class="o">*</span><span class="n">Type</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

    <span class="n">wizphys_manifold</span> <span class="o">*</span><span class="n">M</span><span class="p">;</span>
    <span class="n">wiz_entity</span> <span class="o">*</span><span class="n">E</span><span class="p">;</span>

    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">arraylen</span><span class="p">(</span><span class="n">Map</span><span class="o">-&gt;</span><span class="n">ents</span><span class="p">);</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">E</span> <span class="o">=</span> <span class="n">Map</span><span class="o">-&gt;</span><span class="n">ents</span> <span class="o">+</span> <span class="n">i</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">flagcheck</span><span class="p">(</span><span class="n">E</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">,</span> <span class="n">EFLAG_EXISTS</span><span class="p">))</span> <span class="k">continue</span><span class="p">;</span>

        <span class="cm">/* The tile material only matters for grounded entities */</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">E</span><span class="o">-&gt;</span><span class="n">offground</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">v2</span> <span class="n">Resident</span> <span class="o">=</span> <span class="n">V2</span><span class="p">(</span><span class="n">E</span><span class="o">-&gt;</span><span class="n">p</span><span class="p">.</span><span class="n">x</span><span class="o">/</span><span class="mi">16</span><span class="p">,</span> <span class="n">E</span><span class="o">-&gt;</span><span class="n">p</span><span class="p">.</span><span class="n">y</span><span class="o">/</span><span class="mi">16</span><span class="p">);</span>

            <span class="cm">/* Check map bounds */</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">rect_contains</span><span class="p">(</span><span class="n">MapBounds</span><span class="p">,</span> <span class="n">Resident</span><span class="p">))</span>
            <span class="p">{</span>
                <span class="cm">/* Get the tile type */</span>
                <span class="n">Tile</span> <span class="o">=</span> <span class="n">Map</span><span class="o">-&gt;</span><span class="n">tiles</span><span class="p">[</span><span class="n">Resident</span><span class="p">.</span><span class="n">x</span> <span class="o">+</span> <span class="n">Resident</span><span class="p">.</span><span class="n">y</span> <span class="o">*</span> <span class="n">Map</span><span class="o">-&gt;</span><span class="n">w</span><span class="p">];</span>
                <span class="n">Type</span> <span class="o">=</span> <span class="n">Map</span><span class="o">-&gt;</span><span class="n">ts</span><span class="p">.</span><span class="n">types</span> <span class="o">+</span> <span class="n">Tile</span><span class="p">;</span>

                <span class="cm">/* Call the handler */</span>
                <span class="n">wizphys_tilemat_handler</span> <span class="n">Handler</span> <span class="o">=</span> <span class="n">__wizpyhs_mats</span><span class="p">[</span><span class="n">Type</span><span class="o">-&gt;</span><span class="n">material</span><span class="p">];</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">Handler</span><span class="p">)</span> <span class="n">Handler</span><span class="p">(</span><span class="n">E</span><span class="p">);</span>

                <span class="cm">/* Update entity material */</span>
                <span class="n">E</span><span class="o">-&gt;</span><span class="n">tmat</span> <span class="o">=</span> <span class="n">Type</span><span class="o">-&gt;</span><span class="n">material</span><span class="p">;</span>

                <span class="cm">/* Call Lua hook */</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">E</span><span class="o">-&gt;</span><span class="n">tmat</span> <span class="o">!=</span> <span class="n">E</span><span class="o">-&gt;</span><span class="n">tmatPrev</span><span class="p">)</span> <span class="p">{</span>
                    <span class="n">wiz_entity_call_tmat</span><span class="p">(</span><span class="n">E</span><span class="p">,</span> <span class="n">E</span><span class="o">-&gt;</span><span class="n">tmatPrev</span><span class="p">,</span> <span class="n">E</span><span class="o">-&gt;</span><span class="n">tmat</span><span class="p">);</span>
                    <span class="n">E</span><span class="o">-&gt;</span><span class="n">tmatPrev</span> <span class="o">=</span> <span class="n">E</span><span class="o">-&gt;</span><span class="n">tmat</span><span class="p">;</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span></code>
</pre>


<p>To be quite honest, it&rsquo;s a little embarrassing looking at my
old code. I'd like to think I have a cleaner style these
days.</p>

<h2>A Zelda-like in HaxeFlixel</h2>

<p>Eventually life got a little too busy and I didn&rsquo;t have the
time for Wizwag. Fast-forward to a year or so later, when I
wanted to experiment with Haxe and HaxeFlixel. I decided to
see how it would compare to my from-scratch attempt in C,
and started rewriting.</p>

<p>This time, I wanted to see if I could get by with a 3rd
party map editor, and tried my go-to choice,
<a href="https://thorbjorn.itch.io/tiled">Tiled.</a></p>

<p>Sadly, this meant either remaking my supertiles into
ordinary ones:</p>

<p><img src="../img/zeldascreens/ts_overworld.png" alt="screencap of a tileset" /></p>

<p>Wizwag was always planned to have a big, visually contiguous
overworld, which scrolled screen-by-screen, befitting its
inspirations. The easiest way to accomplish this would have
been to make a giant map in Tiled, and split it into screens
programmatically, but this felt icky and disorganized.</p>

<p>How would I determine which objects belonged to which rooms?
What if an object&rsquo;s origin was <em>outside</em> its resident room?</p>

<p>At the time, Tiled didn&rsquo;t have the &ldquo;connected maps&rdquo; feature,
so I made the map the size of one chunk, then made layer
groups and shifted them into place. Each room group was
named with its location in the world map grid.</p>

<p><img src="../img/zeldascreens/tiled.png" alt="tiled screenshot" /></p>

<p>The default <code>.tmx</code> loader in Haxeflixel couldn&rsquo;t accomodate
this, naturally, so I went and wrote one that could load the
basic information about all the rooms (without loading
<em>everything</em>), then provide a &ldquo;finalized&rdquo; room on request.</p>

<p>Then, I developed the lighting system explored in
<a href="../posts/haxeflixel-lighting.html">HaxeFlixel Lighting Adventure</a>,
which I have been happy to see used in several other
projects by other devs. :)</p>

<p>Then, I needed to figure out how to do Zelda-style scrolling
screen transitions. Before long, I had written this proof of
concept, which could use some cleanup:</p>

<pre class="highlight lang_haxe"><code><span></span><span class="c1">//  1) move the player one tile in that direction</span>
<span class="c1">//  2) load the new room</span>
<span class="c1">//  3) [do cool camera slide]</span>
<span class="c1">//  4) unload old room</span>

<span class="c1">// first, we need to determine which room to try to load</span>
<span class="kd">var</span> loadDirection <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">;</span>
<span class="k">if</span> <span class="p">(</span><span class="n">_player</span><span class="p">.</span><span class="n">x</span> <span class="o">&gt;</span> <span class="n">floor</span><span class="p">.</span><span class="n">width</span> <span class="o">-</span> <span class="mi">4</span><span class="p">)</span>
    <span class="n">loadDirection</span> <span class="o">=</span> <span class="s2">&quot;r&quot;</span><span class="p">;</span>
<span class="k">if</span> <span class="p">(</span><span class="n">_player</span><span class="p">.</span><span class="n">x</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">loadDirection</span> <span class="o">=</span> <span class="s2">&quot;l&quot;</span><span class="p">;</span>
<span class="k">if</span> <span class="p">(</span><span class="n">_player</span><span class="p">.</span><span class="n">y</span> <span class="o">&gt;</span> <span class="n">floor</span><span class="p">.</span><span class="n">height</span> <span class="o">-</span> <span class="mi">4</span><span class="p">)</span>
    <span class="n">loadDirection</span> <span class="o">=</span> <span class="s2">&quot;d&quot;</span><span class="p">;</span>
<span class="k">if</span> <span class="p">(</span><span class="n">_player</span><span class="p">.</span><span class="n">y</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">loadDirection</span> <span class="o">=</span> <span class="s2">&quot;u&quot;</span><span class="p">;</span>

<span class="k">if</span> <span class="p">(</span><span class="s2">&quot;&quot;</span> <span class="o">!=</span> <span class="n">loadDirection</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">trace</span><span class="p">(</span><span class="s2">&quot;moving to: &quot;</span> <span class="o">+</span> <span class="n">loadDirection</span><span class="p">);</span>

    <span class="c1">// check if our map has a room we can go to</span>
    <span class="kd">var</span> newID<span class="p">:</span><span class="n">String</span> <span class="o">=</span> <span class="n">_map</span><span class="p">.</span><span class="n">getAdjacentRoomID</span><span class="p">(</span><span class="n">_roomID</span><span class="p">,</span> <span class="n">loadDirection</span><span class="p">);</span>
    <span class="k">try</span> <span class="p">{</span>
        <span class="c1">// load the new room</span>
        <span class="n">_newRoom</span> <span class="o">=</span> <span class="n">_map</span><span class="p">.</span><span class="n">loadRoom</span><span class="p">(</span><span class="n">newID</span><span class="p">);</span>

        <span class="c1">// animation time</span>
        <span class="kd">var</span> tweenLength <span class="o">=</span> <span class="mf">0.5</span><span class="p">;</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">_newRoom</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">trace</span><span class="p">(</span><span class="s2">&quot;-- got new room --&quot;</span><span class="p">);</span>
            <span class="n">_roomID</span> <span class="o">=</span> <span class="n">newID</span><span class="p">;</span>

            <span class="c1">// set up new room</span>
            <span class="n">_roomContainer</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">_newRoom</span><span class="p">);</span>
            <span class="n">_player</span><span class="p">.</span><span class="n">scrollFactor</span><span class="p">.</span><span class="n">set</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span>

            <span class="c1">// the &quot;floor&quot; is the tile map itself, sans entities.</span>
            <span class="c1">// we move the new room&#39;s tilemap off-screen before the animation.</span>
            <span class="kd">var</span> floor <span class="o">=</span> <span class="n">_room</span><span class="p">.</span><span class="n">floor</span><span class="p">;</span>
            <span class="k">switch</span> <span class="p">(</span><span class="n">loadDirection</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">case</span> <span class="s2">&quot;r&quot;</span><span class="p">:</span>
                    <span class="n">_newRoom</span><span class="p">.</span><span class="n">floor</span><span class="p">.</span><span class="n">x</span> <span class="o">=</span> <span class="n">floor</span><span class="p">.</span><span class="n">x</span> <span class="o">+</span> <span class="n">floor</span><span class="p">.</span><span class="n">width</span><span class="p">;</span>
                    <span class="n">FlxTween</span><span class="p">.</span><span class="n">tween</span><span class="p">(</span><span class="n">_player</span><span class="p">,</span> <span class="p">{</span><span class="n">x</span><span class="p">:</span><span class="mi">8</span><span class="p">},</span> <span class="n">tweenLength</span><span class="p">);</span>
                <span class="k">case</span> <span class="s2">&quot;l&quot;</span><span class="p">:</span>
                    <span class="n">_newRoom</span><span class="p">.</span><span class="n">floor</span><span class="p">.</span><span class="n">x</span> <span class="o">=</span>  <span class="n">floor</span><span class="p">.</span><span class="n">x</span> <span class="o">-</span> <span class="n">_newRoom</span><span class="p">.</span><span class="n">floor</span><span class="p">.</span><span class="n">width</span><span class="p">;</span>
                    <span class="n">FlxTween</span><span class="p">.</span><span class="n">tween</span><span class="p">(</span><span class="n">_player</span><span class="p">,</span> <span class="p">{</span><span class="n">x</span><span class="p">:</span><span class="n">floor</span><span class="p">.</span><span class="n">width</span> <span class="o">-</span> <span class="mi">8</span><span class="p">},</span> <span class="n">tweenLength</span><span class="p">);</span>
                <span class="k">case</span> <span class="s2">&quot;d&quot;</span><span class="p">:</span>
                    <span class="n">_newRoom</span><span class="p">.</span><span class="n">floor</span><span class="p">.</span><span class="n">y</span> <span class="o">=</span> <span class="n">floor</span><span class="p">.</span><span class="n">y</span> <span class="o">+</span> <span class="n">floor</span><span class="p">.</span><span class="n">height</span><span class="p">;</span>
                    <span class="n">FlxTween</span><span class="p">.</span><span class="n">tween</span><span class="p">(</span><span class="n">_player</span><span class="p">,</span> <span class="p">{</span><span class="n">y</span><span class="p">:</span><span class="mi">8</span><span class="p">},</span> <span class="n">tweenLength</span><span class="p">);</span>
                <span class="k">case</span> <span class="s2">&quot;u&quot;</span><span class="p">:</span>
                    <span class="n">_newRoom</span><span class="p">.</span><span class="n">floor</span><span class="p">.</span><span class="n">y</span> <span class="o">=</span> <span class="n">floor</span><span class="p">.</span><span class="n">y</span> <span class="o">-</span> <span class="n">_newRoom</span><span class="p">.</span><span class="n">floor</span><span class="p">.</span><span class="n">height</span><span class="p">;</span>
                    <span class="n">FlxTween</span><span class="p">.</span><span class="n">tween</span><span class="p">(</span><span class="n">_player</span><span class="p">,</span> <span class="p">{</span><span class="n">y</span><span class="p">:</span><span class="n">floor</span><span class="p">.</span><span class="n">height</span> <span class="o">-</span> <span class="mi">8</span><span class="p">},</span> <span class="n">tweenLength</span><span class="p">);</span>
            <span class="p">}</span>

            <span class="c1">// now, we need to pause input.</span>
            <span class="n">Input</span><span class="p">.</span><span class="n">enabled</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>

            <span class="c1">// if another room transition is happening for some reason, we need to stop it.</span>
            <span class="k">if</span> <span class="p">(</span><span class="kc">null</span> <span class="o">!=</span> <span class="n">_tween</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">_tween</span><span class="p">.</span><span class="n">cancel</span><span class="p">();</span>
                <span class="n">_tween</span><span class="p">.</span><span class="n">destroy</span><span class="p">();</span>
            <span class="p">}</span>

            <span class="c1">// gather all the attributes we need to animate.</span>
            <span class="n">_prevColor</span> <span class="o">=</span> <span class="n">FlxG</span><span class="p">.</span><span class="n">camera</span><span class="p">.</span><span class="n">color</span><span class="p">;</span>

            <span class="c1">// the animation itself</span>
            <span class="n">_tween</span> <span class="o">=</span> <span class="n">FlxTween</span><span class="p">.</span><span class="n">color</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="n">tweenLength</span><span class="p">,</span> <span class="n">FlxG</span><span class="p">.</span><span class="n">camera</span><span class="p">.</span><span class="n">color</span><span class="p">,</span> <span class="n">_newRoom</span><span class="p">.</span><span class="n">tint</span><span class="p">,</span>
                <span class="p">{</span><span class="n">onUpdate</span><span class="p">:</span><span class="kd">function</span><span class="p">(</span><span class="n">t</span><span class="p">:</span><span class="n">FlxTween</span><span class="p">)</span> <span class="p">{</span>
                    <span class="c1">// sliiide to the left, sliiide to the right</span>
                    <span class="n">_lighting</span><span class="p">.</span><span class="n">color</span> <span class="o">=</span> <span class="n">FlxColor</span><span class="p">.</span><span class="n">interpolate</span><span class="p">(</span><span class="n">_room</span><span class="p">.</span><span class="n">tint</span><span class="p">,</span> <span class="n">_newRoom</span><span class="p">.</span><span class="n">tint</span><span class="p">,</span> <span class="n">t</span><span class="p">.</span><span class="n">percent</span><span class="p">);</span>
                    <span class="n">_lighting</span><span class="p">.</span><span class="n">alpha</span> <span class="o">=</span> <span class="n">FlxMath</span><span class="p">.</span><span class="n">lerp</span><span class="p">(</span><span class="n">_room</span><span class="p">.</span><span class="n">darkness</span><span class="p">,</span> <span class="n">_newRoom</span><span class="p">.</span><span class="n">darkness</span><span class="p">,</span> <span class="n">t</span><span class="p">.</span><span class="n">percent</span><span class="p">);</span>

                    <span class="kd">var</span> midp0 <span class="o">=</span> <span class="n">_room</span><span class="p">.</span><span class="n">floor</span><span class="p">.</span><span class="n">getMidpoint</span><span class="p">();</span>
                    <span class="kd">var</span> midp1 <span class="o">=</span> <span class="n">_newRoom</span><span class="p">.</span><span class="n">floor</span><span class="p">.</span><span class="n">getMidpoint</span><span class="p">();</span>
                    <span class="n">FlxG</span><span class="p">.</span><span class="n">camera</span><span class="p">.</span><span class="n">focusOn</span><span class="p">(</span><span class="k">new</span> <span class="n">FlxPoint</span><span class="p">(</span>
                        <span class="n">FlxMath</span><span class="p">.</span><span class="n">lerp</span><span class="p">(</span><span class="n">midp0</span><span class="p">.</span><span class="n">x</span><span class="p">,</span> <span class="n">midp1</span><span class="p">.</span><span class="n">x</span><span class="p">,</span> <span class="n">t</span><span class="p">.</span><span class="n">percent</span><span class="p">),</span>
                        <span class="n">FlxMath</span><span class="p">.</span><span class="n">lerp</span><span class="p">(</span><span class="n">midp0</span><span class="p">.</span><span class="n">y</span><span class="p">,</span> <span class="n">midp1</span><span class="p">.</span><span class="n">y</span><span class="p">,</span> <span class="n">t</span><span class="p">.</span><span class="n">percent</span><span class="p">)</span>
                    <span class="p">));</span>
                <span class="p">},</span>
                <span class="n">onComplete</span><span class="p">:</span><span class="kd">function</span><span class="p">(</span><span class="n">t</span><span class="p">:</span><span class="n">FlxTween</span><span class="p">)</span> <span class="p">{</span>
                    <span class="c1">// put things back</span>
                    <span class="n">_player</span><span class="p">.</span><span class="n">scrollFactor</span><span class="p">.</span><span class="n">set</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">);</span>

                    <span class="c1">// set up lighting in the new room</span>
                    <span class="n">_lighting</span><span class="p">.</span><span class="n">remove</span><span class="p">(</span><span class="n">_room</span><span class="p">.</span><span class="n">lights</span><span class="p">);</span>
                    <span class="n">_room</span><span class="p">.</span><span class="n">lights</span><span class="p">.</span><span class="n">destroy</span><span class="p">();</span>

                    <span class="n">_lighting</span><span class="p">.</span><span class="n">color</span> <span class="o">=</span> <span class="n">_newRoom</span><span class="p">.</span><span class="n">tint</span><span class="p">;</span>
                    <span class="n">_lighting</span><span class="p">.</span><span class="n">alpha</span> <span class="o">=</span> <span class="n">_newRoom</span><span class="p">.</span><span class="n">darkness</span><span class="p">;</span>

                    <span class="n">_roomContainer</span><span class="p">.</span><span class="n">remove</span><span class="p">(</span><span class="n">_room</span><span class="p">);</span>
                    <span class="n">_room</span><span class="p">.</span><span class="n">destroy</span><span class="p">();</span> <span class="c1">// greatly improved memory performance</span>
                    <span class="n">_room</span> <span class="o">=</span> <span class="n">_newRoom</span><span class="p">;</span>
                    <span class="n">_newRoom</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>

                    <span class="c1">// finalize room, load objects and physics and stuff</span>
                    <span class="n">_room</span><span class="p">.</span><span class="n">finalize</span><span class="p">();</span>

                    <span class="c1">// add new lights to lighting system</span>
                    <span class="n">_lighting</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">_room</span><span class="p">.</span><span class="n">lights</span><span class="p">);</span>

                    <span class="c1">// resume</span>
                    <span class="n">Input</span><span class="p">.</span><span class="n">enabled</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
                <span class="p">}});</span>
        <span class="p">}</span>
    <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="n">e</span><span class="p">:</span><span class="n">Dynamic</span><span class="p">)</span> <span class="n">trace</span><span class="p">(</span><span class="n">Std</span><span class="p">.</span><span class="n">string</span><span class="p">(</span><span class="n">e</span><span class="p">));</span>

<span class="p">}</span> <span class="c1">// end if (&quot;&quot; != loadDirection)</span></code>
</pre>


<p>You can see the transitions in action here:</p>

<p><embed src="../img/zeldascreens/wizwag-hx-transitions.mp4" autostart="true" /></p>

<p>If I return to this project eventually, I will likely create
a more general solution to this problem that I can share
properly, as I did with the lighting system.</p>
</div>
</div>

	
	<div class="footer">
		<p>
			Copyright &copy; Pennie Quinn 2019
			&middot;
			Generated on Sun Aug 25 13:17:26 2019
			&middot;
			<a href="../index.html">Home</a>
		</p>
	</div>
	
	<script type="text/javascript">
		//if (navigator.appVersion.indexOf("Win") >= 0) { document.body.className=""; }
	</script>
</body>
</html>